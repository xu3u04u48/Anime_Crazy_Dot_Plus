<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>FFmpeg Web Converter (Ready Fixed)</title>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.15/dist/umd/ffmpeg.js"></script>
  <style>
    body { font-family: monospace; background: #111; color: #0f0; padding: 10px; }
    #status { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="status">載入中...</div>
  <script>
    let ffmpeg;
    let createFFmpeg, fetchFile;
    let isReady = false;

    function logStatus(msg) {
      console.log(msg);
      const statusDiv = document.getElementById('status');
      statusDiv.textContent += "\n" + msg;
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    async function initFFmpeg() {
      try {
        ({ createFFmpeg, fetchFile } = FFmpegWASM);
        ffmpeg = createFFmpeg({ log: true, logger: ({ message }) => logStatus(message) });
        logStatus('正在初始化 FFmpeg...');
        await ffmpeg.load();
        isReady = true;
        logStatus('初始化完成，等待資料傳入...');
        window.parent.postMessage({ status: 'ready' }, '*');
      } catch (e) {
        logStatus('初始化失敗: ' + e.message);
        console.error(e);
      }
    }

    const checkFFmpegReady = setInterval(() => {
      if (window.FFmpeg) {
        clearInterval(checkFFmpegReady);
        initFFmpeg();
      }
    }, 50);

    window.addEventListener('message', async (event) => {
      if (!event.data || !event.data.command) return;
      const { command, data, fileName } = event.data;
      if (!isReady) {
        logStatus('FFmpeg 尚未初始化完成，無法開始轉檔。');
        window.parent.postMessage({ status: 'error', message: 'FFmpeg 尚未初始化完成，請稍後再試。' }, '*');
        return;
      }

      if (command === 'convert') {
        logStatus('收到轉檔指令，開始處理...');
        try {
          const uint8Data = new Uint8Array(data);
          await ffmpeg.FS('writeFile', fileName, uint8Data);
          logStatus(`已寫入檔案 ${fileName}, 開始轉檔...`);

          const outputName = 'output.mp3';
          await ffmpeg.run('-i', fileName, '-vn', '-acodec', 'libmp3lame', '-q:a', '3', outputName);
          logStatus('轉檔完成，讀取輸出檔案...');

          const outData = ffmpeg.FS('readFile', outputName);
          const blob = new Blob([outData.buffer], { type: 'audio/mpeg' });
          const url = URL.createObjectURL(blob);

          logStatus('轉檔完成，可下載。');
          window.parent.postMessage({ status: 'done', url, name: outputName }, '*');
        } catch (e) {
          logStatus('轉檔失敗: ' + e.message);
          console.error(e);
          window.parent.postMessage({ status: 'error', message: e.message }, '*');
        }
      }
    });
  </script>
</body>
</html>